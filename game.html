document.getElementById("endTurnBtn").addEventListener("click", async () => {
  const endStatus = document.getElementById("endStatus");

  // 設定自己已結束
  const endRef = ref(db, `rooms/${room}/players/${player}/ended`);
  await update(endRef, true);
  endStatus.textContent = "✅ 你已結束今日動作，等待其他玩家...";

  // 取得所有玩家資料
  const playersRef = ref(db, `rooms/${room}/players`);
  const playersSnap = await get(playersRef);
  const players = playersSnap.val() || {};

  // 檢查是否所有人都結束
  let allEnded = true;
  for (let name in players) {
    if (!players[name].ended) {
      allEnded = false;
      break;
    }
  }

  if (allEnded) {
    // ✅ 所有人都結束：每人加 100 元並重設 ended
    for (let name in players) {
      const money = players[name].money || 0;
      const playerRef = ref(db, `rooms/${room}/players/${name}`);
      await update(playerRef, {
        money: money + 100,
        ended: false
      });
    }
    endStatus.textContent = "🎉 所有人皆已結束！新的一天開始，已發放 $100";
  }
});
